#!/bin/bash

# {{ basic.worker_name }} - Deployment Script
# Generated by {{ metadata.generated_by }}

set -e

echo "üöÄ Deploying {{ basic.worker_name }}..."

# Check if wrangler is installed
if ! command -v wrangler &> /dev/null; then
    echo "‚ùå Error: wrangler CLI not found"
    echo "Install with: npm install -g wrangler"
    exit 1
fi

# Check authentication
echo "üìã Checking Cloudflare authentication..."
if ! wrangler whoami &> /dev/null; then
    echo "‚ùå Not authenticated with Cloudflare"
    echo "Run: wrangler login"
    exit 1
fi

echo "‚úÖ Authenticated"

# Check if secrets are set
echo "üîê Checking required secrets..."
SECRETS=$(wrangler secret list 2>/dev/null || echo "")

if [[ ! $SECRETS =~ "TWILIO_ACCOUNT_SID" ]]; then
    echo "‚ö†Ô∏è  TWILIO_ACCOUNT_SID not set"
    echo "Run: wrangler secret put TWILIO_ACCOUNT_SID"
    read -p "Do you want to set it now? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        wrangler secret put TWILIO_ACCOUNT_SID
    fi
fi

if [[ ! $SECRETS =~ "TWILIO_AUTH_TOKEN" ]]; then
    echo "‚ö†Ô∏è  TWILIO_AUTH_TOKEN not set"
    echo "Run: wrangler secret put TWILIO_AUTH_TOKEN"
    read -p "Do you want to set it now? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        wrangler secret put TWILIO_AUTH_TOKEN
    fi
fi

if [[ ! $SECRETS =~ "TWILIO_PHONE_NUMBER" ]]; then
    echo "‚ö†Ô∏è  TWILIO_PHONE_NUMBER not set"
    echo "Run: wrangler secret put TWILIO_PHONE_NUMBER"
    read -p "Do you want to set it now? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        wrangler secret put TWILIO_PHONE_NUMBER
    fi
fi

{% if rate_limit.enabled and rate_limit.storage == "kv" %}
# Check KV namespace
echo "üóÑÔ∏è  Checking KV namespace..."
if ! grep -q "YOUR_KV_NAMESPACE_ID" wrangler.toml; then
    echo "‚úÖ KV namespace configured"
else
    echo "‚ö†Ô∏è  KV namespace not configured in wrangler.toml"
    echo "Run: npm run kv:create"
    read -p "Do you want to create it now? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        NAMESPACE_ID=$(wrangler kv:namespace create "RATE_LIMIT_KV" | grep "id =" | cut -d'"' -f2)
        echo "KV Namespace created: $NAMESPACE_ID"
        echo "Update wrangler.toml with this ID"
        exit 0
    fi
fi
{% endif %}

# Install dependencies
echo "üì¶ Installing dependencies..."
npm install

# Type check
echo "üîç Running type check..."
npm run check

# Deploy
echo "üöÄ Deploying to Cloudflare..."
wrangler deploy

echo ""
echo "‚úÖ Deployment complete!"
echo ""
echo "üìß Next steps:"
echo "1. Go to https://dash.cloudflare.com/"
echo "2. Navigate to {{ basic.domain }} ‚Üí Email ‚Üí Email Routing"
echo "3. Add routing rule:"
echo "   - Match: {{ routing.email_routing_pattern.replace('{domain}', basic.domain) }}"
echo "   - Action: Send to Worker"
echo "   - Worker: {{ basic.worker_name }}"
echo ""
echo "üß™ Test by sending email to: 15551234567@{{ basic.domain }}"
echo "   (Replace 15551234567 with actual phone number)"
echo ""
echo "üìä View logs: npm run tail"
echo ""
