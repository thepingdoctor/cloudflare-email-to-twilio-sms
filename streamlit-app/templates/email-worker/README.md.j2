# {{ basic.worker_name }}

Cloudflare Email Worker for routing emails to SMS via Twilio.

## Overview

This worker processes incoming emails through Cloudflare Email Routing and forwards them as SMS messages using the Twilio API.

**Email Pattern:** `{{ routing.email_routing_pattern.replace('{domain}', basic.domain) }}`

## Features

- ‚úâÔ∏è Email-to-SMS routing via Cloudflare Email Routing
- üì± Twilio SMS integration
{% if rate_limit.enabled %}
- üö¶ Rate limiting ({{ rate_limit.per_sender }} per sender/hour, {{ rate_limit.per_recipient }} per recipient/hour)
{% endif %}
{% if retry.enabled %}
- üîÑ Automatic retry with {{ retry.backoff_strategy }} backoff (up to {{ retry.max_retries }} retries)
{% endif %}
{% if security.enable_sender_whitelist %}
- üîí Sender whitelist enforcement
{% endif %}
{% if logging.enabled %}
- üìä Analytics and logging
{% endif %}
- üåç E.164 phone number format support
- üìè SMS length truncation ({{ routing.max_message_length }} characters)

## Quick Start

### 1. Install Dependencies

```bash
npm install
```

### 2. Configure Twilio Secrets

```bash
wrangler secret put TWILIO_ACCOUNT_SID
wrangler secret put TWILIO_AUTH_TOKEN
wrangler secret put TWILIO_PHONE_NUMBER
```

Enter your Twilio credentials when prompted.

{% if rate_limit.enabled and rate_limit.storage == "kv" %}
### 3. Create KV Namespace

```bash
npm run kv:create
```

Update `wrangler.toml` with the returned namespace ID.
{% endif %}

### {{ '4' if rate_limit.enabled else '3' }}. Deploy Worker

```bash
npm run deploy
```

### {{ '5' if rate_limit.enabled else '4' }}. Configure Email Routing

1. Go to [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. Select your domain: **{{ basic.domain }}**
3. Navigate to **Email** ‚Üí **Email Routing**
4. Click **Enable Email Routing** (if not already enabled)
5. Add a **Routing Rule**:
   - **Match:** `{{ routing.email_routing_pattern.replace('{domain}', basic.domain) }}`
   - **Action:** Send to Worker
   - **Worker:** `{{ basic.worker_name }}`

### {{ '6' if rate_limit.enabled else '5' }}. Test

Send an email to: `15551234567@{{ basic.domain }}`

Replace `15551234567` with the recipient's phone number (E.164 format).

## Usage

### Email Format

**To:** `<phone-number>@{{ basic.domain }}`
- Phone numbers must be in E.164 format (e.g., +15551234567)
- Can omit the `+` if using {{ routing.default_country_code }} as default

**Subject:** {% if routing.email_subject_in_message %}Included in SMS message{% else %}Not included in SMS{% endif %}

**Body:** Message content (truncated to {{ routing.max_message_length }} characters)

### Examples

```
To: 15551234567@{{ basic.domain }}
Subject: Meeting Reminder
Body: Don't forget the meeting at 3pm today!
```

This will send an SMS to +15551234567 with the message{% if routing.email_subject_in_message %} including the subject{% endif %}.

## Development

### Local Testing

```bash
npm run dev
```

### Type Checking

```bash
npm run check
```

### View Logs

```bash
npm run tail
```

## Configuration

### Rate Limiting

{% if rate_limit.enabled %}
- **Per Sender:** {{ rate_limit.per_sender }} emails/hour
- **Per Recipient:** {{ rate_limit.per_recipient }} emails/hour
- **Global Limit:** {{ rate_limit.global_limit }} emails/hour
{% else %}
Rate limiting is disabled.
{% endif %}

### Phone Number Extraction

- **Method:** {{ routing.phone_extraction_method }}
- **Default Country Code:** {{ routing.default_country_code }}

### Content Processing

- **Strip HTML:** {% if routing.strip_html %}Yes{% else %}No{% endif %}
- **Include Sender Info:** {% if routing.include_sender_info %}Yes{% else %}No{% endif %}
- **Max Message Length:** {{ routing.max_message_length }} characters

## Monitoring

{% if logging.enabled %}
### View Analytics

```bash
# Real-time logs
wrangler tail {{ basic.worker_name }}

# Cloudflare Dashboard
# Navigate to Analytics & Logs ‚Üí Analytics Engine
```

### Event Types

- `sms_sent` - SMS successfully sent
- `sms_failed` - SMS send failed
- `invalid_phone` - Invalid phone number format
- `rate_limited` - Rate limit exceeded
{% if security.enable_sender_whitelist %}
- `sender_blocked` - Sender not in whitelist
{% endif %}
- `processing_error` - General processing error
{% else %}
Logging is disabled. Enable in configuration to track events.
{% endif %}

## Troubleshooting

### Email not being processed

1. Verify email routing is enabled on {{ basic.domain }}
2. Check routing rule matches: `{{ routing.email_routing_pattern.replace('{domain}', basic.domain) }}`
3. Confirm worker is deployed: `wrangler deployments list`

### SMS not sending

1. Check Twilio credentials: `wrangler secret list`
2. View logs: `npm run tail`
3. Verify phone number is in E.164 format
4. Check Twilio account balance and phone number capabilities

### Rate limit errors

1. Verify KV namespace is created and bound in `wrangler.toml`
2. Check rate limit counters in KV namespace
3. Adjust limits in configuration if needed

### Invalid recipient errors

1. Email address must contain valid phone number
2. Format: `<number>@{{ basic.domain }}`
3. Phone must be valid E.164 format (e.g., +15551234567)

## Security

{% if security.enable_sender_whitelist %}
### Sender Whitelist

Only emails from these addresses are processed:
{% for sender in security.sender_whitelist %}
- {{ sender }}
{% endfor %}
{% endif %}

{% if security.require_spf or security.require_dkim %}
### Email Authentication

{% if security.require_spf %}- SPF verification required{% endif %}
{% if security.require_dkim %}- DKIM verification required{% endif %}
{% endif %}

## Metadata

- **Version:** {{ metadata.version }}
- **Generated:** {{ metadata.generated_at }}
{% if metadata.author %}
- **Author:** {{ metadata.author }}
{% endif %}
- **Generator:** {{ metadata.generated_by }}

## Support

For issues or questions:
- Cloudflare Email Routing: https://developers.cloudflare.com/email-routing/
- Twilio API: https://www.twilio.com/docs/sms
- Workers Documentation: https://developers.cloudflare.com/workers/

## License

MIT
