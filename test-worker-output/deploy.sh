#!/bin/bash
# Deployment script for test-email-to-sms
# Generated by: security-validation-test

set -e

echo "üöÄ Deploying test-email-to-sms..."

# Check if wrangler is installed
if ! command -v wrangler &> /dev/null; then
    echo "‚ùå Wrangler CLI not found. Installing..."
    npm install -g wrangler
fi

# Install dependencies
echo "üì¶ Installing dependencies..."
npm install

# Type check
echo "üîç Type checking..."
npm run check

# Create KV namespaces if needed
echo "üóÑÔ∏è  Setting up KV namespaces..."
if ! wrangler kv:namespace list | grep -q "RATE_LIMIT_KV"; then
    echo "Creating RATE_LIMIT_KV namespace..."
    wrangler kv:namespace create "RATE_LIMIT_KV"
    echo "‚ö†Ô∏è  Please update wrangler.toml with the namespace ID"
fi


# Check secrets
echo "üîê Checking secrets..."
SECRETS_OK=true

if ! wrangler secret list | grep -q "TWILIO_ACCOUNT_SID"; then
    echo "‚ö†Ô∏è  TWILIO_ACCOUNT_SID not set"
    SECRETS_OK=false
fi

if ! wrangler secret list | grep -q "TWILIO_AUTH_TOKEN"; then
    echo "‚ö†Ô∏è  TWILIO_AUTH_TOKEN not set"
    SECRETS_OK=false
fi

if ! wrangler secret list | grep -q "TWILIO_PHONE_NUMBER"; then
    echo "‚ö†Ô∏è  TWILIO_PHONE_NUMBER not set"
    SECRETS_OK=false
fi

if [ "$SECRETS_OK" = false ]; then
    echo ""
    echo "‚ùå Secrets are missing. Set them using:"
    echo "   wrangler secret put TWILIO_ACCOUNT_SID"
    echo "   wrangler secret put TWILIO_AUTH_TOKEN"
    echo "   wrangler secret put TWILIO_PHONE_NUMBER"
    echo ""
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Deploy
echo "üö¢ Deploying worker..."
wrangler deploy

echo ""
echo "‚úÖ Deployment complete!"
echo ""
echo "üìß Next steps:"
echo "1. Configure Email Routing in Cloudflare Dashboard"
echo "2. Add routing rule for: *@sms.test.example.com"
echo "3. Test by sending an email"
echo ""
echo "üîó Worker URL: https://test-email-to-sms.test.example.com"
echo "üè• Health check: https://test-email-to-sms.test.example.com/health"
echo ""